<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실험 시스템 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-results {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>실험 시스템 테스트</h1>
    
    <div class="test-section">
        <h2>1. 실험 생성 테스트</h2>
        <form id="experiment-form">
            <label>실험명:</label>
            <input type="text" id="exp-name" value="테스트 실험 - 메타인지 피드백 효과" required>
            
            <label>설명:</label>
            <textarea id="exp-description" rows="3">이것은 실험 시스템 테스트를 위한 샘플 실험입니다.</textarea>
            
            <label>시작일:</label>
            <input type="date" id="exp-start-date" required>
            
            <label>기간 (주):</label>
            <input type="number" id="exp-duration" value="8" min="1" max="24">
            
            <button type="submit" class="test-button">실험 생성</button>
        </form>
        
        <div id="experiment-result" class="test-results" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 가설 추가 테스트</h2>
        <div>
            <label>가설 내용:</label>
            <textarea id="hypothesis-text" rows="3" placeholder="가설을 입력하세요...">메타인지 피드백을 받은 학생들이 통제군보다 더 나은 학습 성과를 보일 것이다.</textarea>
            
            <button onclick="testAddHypothesis()" class="test-button">가설 추가</button>
        </div>
        
        <div id="hypothesis-result" class="test-results" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>3. DB 연결 테스트</h2>
        <div>
            <label>테이블명:</label>
            <input type="text" id="table-name" value="mdl_quiz_attempts" placeholder="테이블명을 입력하세요...">
            
            <button onclick="testDatabaseConnection()" class="test-button">DB 연결 추가</button>
        </div>
        
        <div id="database-result" class="test-results" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 시스템 상태</h2>
        <button onclick="checkSystemStatus()" class="test-button">시스템 상태 확인</button>
        <div id="status-result" class="test-results" style="display: none;"></div>
    </div>

    <script>
        // 사용자 정보 설정 (테스트용)
        window.USER_ID = 1;
        window.USER_ROLE = 'teacher';
        window.STUDENT_ID = null;
        
        // 현재 날짜 설정
        document.getElementById('exp-start-date').value = new Date().toISOString().split('T')[0];
        
        let currentExperimentId = null;
        
        // 실험 생성 테스트
        document.getElementById('experiment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const experimentData = {
                name: document.getElementById('exp-name').value,
                description: document.getElementById('exp-description').value,
                startDate: document.getElementById('exp-start-date').value,
                durationWeeks: parseInt(document.getElementById('exp-duration').value),
                status: 'planned',
                createdBy: window.USER_ID
            };
            
            try {
                showResult('experiment-result', '실험 생성 중...', false);
                
                const response = await fetch('src/api/database_api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'save_experiment',
                        experiment_name: experimentData.name,
                        description: experimentData.description,
                        start_date: experimentData.startDate,
                        duration_weeks: experimentData.durationWeeks,
                        status: experimentData.status,
                        created_by: experimentData.createdBy
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentExperimentId = result.experiment_id;
                    showResult('experiment-result', `실험 생성 성공! ID: ${result.experiment_id}`, false);
                } else {
                    showResult('experiment-result', `실험 생성 실패: ${result.error}`, true);
                }
                
            } catch (error) {
                showResult('experiment-result', `오류: ${error.message}`, true);
            }
        });
        
        // 가설 추가 테스트
        async function testAddHypothesis() {
            if (!currentExperimentId) {
                showResult('hypothesis-result', '먼저 실험을 생성해주세요.', true);
                return;
            }
            
            const hypothesisText = document.getElementById('hypothesis-text').value;
            
            if (!hypothesisText) {
                showResult('hypothesis-result', '가설 내용을 입력해주세요.', true);
                return;
            }
            
            try {
                showResult('hypothesis-result', '가설 추가 중...', false);
                
                const response = await fetch('src/api/database_api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'save_hypothesis',
                        experiment_id: currentExperimentId,
                        hypothesis_text: hypothesisText,
                        hypothesis_type: 'primary',
                        author_id: window.USER_ID
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('hypothesis-result', `가설 추가 성공! ID: ${result.hypothesis_id}`, false);
                } else {
                    showResult('hypothesis-result', `가설 추가 실패: ${result.error}`, true);
                }
                
            } catch (error) {
                showResult('hypothesis-result', `오류: ${error.message}`, true);
            }
        }
        
        // DB 연결 테스트
        async function testDatabaseConnection() {
            if (!currentExperimentId) {
                showResult('database-result', '먼저 실험을 생성해주세요.', true);
                return;
            }
            
            const tableName = document.getElementById('table-name').value;
            
            if (!tableName) {
                showResult('database-result', '테이블명을 입력해주세요.', true);
                return;
            }
            
            try {
                showResult('database-result', 'DB 연결 추가 중...', false);
                
                const response = await fetch('src/api/database_api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'save_database_connection',
                        experiment_id: currentExperimentId,
                        table_name: tableName,
                        database_name: 'mathking',
                        purpose: '테스트 목적의 DB 연결'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('database-result', 'DB 연결 추가 성공!', false);
                } else {
                    showResult('database-result', `DB 연결 추가 실패: ${result.error}`, true);
                }
                
            } catch (error) {
                showResult('database-result', `오류: ${error.message}`, true);
            }
        }
        
        // 시스템 상태 확인
        async function checkSystemStatus() {
            try {
                showResult('status-result', '시스템 상태 확인 중...', false);
                
                const response = await fetch('src/api/database_api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'test_connection'
                    })
                });
                
                const result = await response.json();
                
                let statusText = `DB 연결 상태: ${result.success ? '성공' : '실패'}\n`;
                statusText += `현재 실험 ID: ${currentExperimentId || '없음'}\n`;
                statusText += `사용자 ID: ${window.USER_ID}\n`;
                statusText += `사용자 역할: ${window.USER_ROLE}`;
                
                showResult('status-result', statusText, !result.success);
                
            } catch (error) {
                showResult('status-result', `오류: ${error.message}`, true);
            }
        }
        
        // 결과 표시 함수
        function showResult(elementId, message, isError) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = isError ? 'test-results error' : 'test-results';
        }
        
        console.log('실험 시스템 테스트 페이지 로드됨');
    </script>
</body>
</html>